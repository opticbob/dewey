<% @page_title = "Family Dashboard - Dewey Library Tracker" %>

<div class="section-header">
    <h1 class="section-title">Family Library Dashboard</h1>
    <form method="post" action="/refresh" style="display: inline;">
        <button type="submit" class="refresh-btn">ðŸ”„ Refresh Now</button>
    </form>
</div>

<% if @data && @data[:stats] %>
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-number"><%= @data[:stats][:total_checkouts] %></span>
            <span class="stat-label">Total Checkouts</span>
        </div>
        <div class="stat-card">
            <span class="stat-number"><%= @data[:stats][:total_holds] %></span>
            <span class="stat-label">Total Holds</span>
        </div>
        <div class="stat-card">
            <span class="stat-number" style="color: <%= @data[:stats][:items_due_soon] > 0 ? '#f57c00' : '#388e3c' %>">
                <%= @data[:stats][:items_due_soon] %>
            </span>
            <span class="stat-label">Due Within 3 Days</span>
        </div>
        <div class="stat-card">
            <span class="stat-number"><%= @data[:stats][:patrons]&.length || 0 %></span>
            <span class="stat-label">Family Members</span>
        </div>
    </div>
<% end %>

<% if @data && @data[:checkouts] && !@data[:checkouts].empty? %>
    <div class="section-header">
        <h2 class="section-title">ðŸ“– Current Checkouts (<%= @data[:checkouts].length %>)</h2>
    </div>

    <div class="table-container">
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 60px;"></th>
                    <th>Title / Author</th>
                    <th style="width: 120px;">Type</th>
                    <th style="width: 150px;">Due Date</th>
                    <th style="width: 120px;">Patron</th>
                </tr>
            </thead>
            <tbody>
                <% @data[:checkouts].each do |item| %>
                    <tr>
                        <td class="thumbnail-cell">
                            <img src="<%= item['thumbnail_url'] || '/placeholder.jpg' %>" alt="<%= item['title'] %>" class="table-thumbnail" loading="lazy">
                        </td>
                        <td class="title-cell">
                            <div class="title-main"><%= item['title'] %></div>
                            <div class="title-author"><%= item['author'] || 'Unknown Author' %></div>
                        </td>
                        <td class="type-cell">
                            <span class="badge badge-type"><%= item['type'] || 'Book' %></span>
                        </td>
                        <td class="due-cell">
                            <div class="<%= due_date_class(item['due_date']) %>">
                                <%= format_due_date(item['due_date']) %>
                            </div>
                            <% if item['renewable'] %>
                                <div class="renewable-badge">âœ“ Renewable</div>
                            <% end %>
                        </td>
                        <td class="patron-cell">
                            <span class="badge badge-patron"><%= item['patron_name'] %></span>
                        </td>
                    </tr>
                <% end %>
            </tbody>
        </table>
    </div>
<% end %>

<% if @data && @data[:holds] && !@data[:holds].empty? %>
    <div class="section-header">
        <h2 class="section-title">ðŸ“‹ Current Holds (<%= @data[:holds].length %>)</h2>
    </div>

    <div class="table-container">
        <table class="items-table">
            <thead>
                <tr>
                    <th style="width: 60px;"></th>
                    <th>Title / Author</th>
                    <th style="width: 150px;">Status</th>
                    <th style="width: 100px;">Position</th>
                    <th style="width: 120px;">Patron</th>
                </tr>
            </thead>
            <tbody>
                <% @data[:holds].each do |item| %>
                    <tr>
                        <td class="thumbnail-cell">
                            <img src="<%= item['thumbnail_url'] || '/placeholder.jpg' %>" alt="<%= item['title'] %>" class="table-thumbnail" loading="lazy">
                        </td>
                        <td class="title-cell">
                            <div class="title-main"><%= item['title'] %></div>
                            <div class="title-author"><%= item['author'] || 'Unknown Author' %></div>
                        </td>
                        <td class="status-cell">
                            <span class="badge <%= status_class(item['status']) %>">
                                <%= item['status'] || 'In Queue' %>
                            </span>
                        </td>
                        <td class="position-cell">
                            <% if item['queue_position'] %>
                                <span class="queue-position">#<%= item['queue_position'] %></span>
                            <% else %>
                                <span style="color: #999;">â€”</span>
                            <% end %>
                        </td>
                        <td class="patron-cell">
                            <span class="badge badge-patron"><%= item['patron_name'] %></span>
                        </td>
                    </tr>
                <% end %>
            </tbody>
        </table>
    </div>
<% end %>

<% if (!@data || (@data[:checkouts]&.empty? && @data[:holds]&.empty?)) %>
    <div class="empty-state">
        <div class="empty-state-icon">ðŸ“š</div>
        <h3>No library activity found</h3>
        <p>No current checkouts or holds. Make sure your library credentials are configured correctly and try refreshing.</p>
    </div>
<% end %>

<% if @data && @data[:last_updated] %>
    <div class="last-updated">
        Last updated: <%= format_timestamp(@data[:last_updated]) %>
    </div>
<% end %>