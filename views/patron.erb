<% @page_title = "#{@patron_name} - Dewey Library Tracker" %>

<div class="section-header">
    <h1 class="section-title">ğŸ“š <%= @patron_name %>'s Library Activity</h1>
    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
        <% if @data && @data[:last_updated] %>
            <div style="font-size: 0.85rem; color: #666;">
                Scraped <%= relative_time(@data[:last_updated]) %>
            </div>
        <% end %>
        <div>
            <a href="/" style="margin-right: 1rem; color: #667eea; text-decoration: none;">â† Back to Family Dashboard</a>
            <form method="post" action="/refresh" style="display: inline;">
                <button type="submit" class="refresh-btn">ğŸ”„ Refresh Now</button>
            </form>
        </div>
    </div>
</div>

<% if @scrape_failures && !@scrape_failures.empty? %>
    <div class="alert-banner">
        <div class="alert-banner-title">
            âš ï¸ Scraping Issues Detected
        </div>
        <div class="alert-banner-content">
            <%= @scrape_failures.length %> scrape <%= @scrape_failures.length == 1 ? 'failure' : 'failures' %> in the last 24 hours. Library data may be outdated.
            <% @scrape_failures.take(3).each do |failure| %>
                <div class="alert-banner-error">
                    <strong><%= failure['patron_name'] %></strong>: <%= failure['error_message'] %>
                    <div class="alert-banner-time"><%= relative_time(failure['timestamp']) %></div>
                </div>
            <% end %>
            <% if @scrape_failures.length > 3 %>
                <div style="margin-top: 0.5rem; color: #999; font-size: 0.85rem;">
                    ... and <%= @scrape_failures.length - 3 %> more failures
                </div>
            <% end %>
        </div>
    </div>
<% end %>

<% if @data && @data[:stats] %>
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-number"><%= @data[:stats][:total_checkouts] %></span>
            <span class="stat-label">Current Checkouts</span>
        </div>
        <div class="stat-card">
            <span class="stat-number"><%= @data[:stats][:total_holds] %></span>
            <span class="stat-label">Current Holds</span>
        </div>
        <div class="stat-card">
            <span class="stat-number" style="color: <%= @data[:stats][:items_overdue] > 0 ? '#d32f2f' : '#388e3c' %>">
                <%= @data[:stats][:items_overdue] %>
            </span>
            <span class="stat-label">Overdue</span>
        </div>
        <div class="stat-card">
            <span class="stat-number" style="color: <%= @data[:stats][:items_due_soon] > 0 ? '#f57c00' : '#388e3c' %>">
                <%= @data[:stats][:items_due_soon] %>
            </span>
            <span class="stat-label">Due Within <%= @data[:stats][:due_soon_days] %> Days</span>
        </div>
    </div>
<% end %>

<% if @data && @data[:checkouts] && !@data[:checkouts].empty? %>
    <%= erb :_checkouts_table, locals: { checkouts: @data[:checkouts], show_patron: false } %>
<% end %>

<% if @data && @data[:holds] && !@data[:holds].empty? %>
    <%= erb :_holds_table, locals: { holds: @data[:holds], show_patron: false } %>
<% end %>

<% if (!@data || (@data[:checkouts]&.empty? && @data[:holds]&.empty?)) %>
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ“š</div>
        <h3><%= @patron_name %> has no current library activity</h3>
        <p>No current checkouts or holds. Try refreshing to check for recent activity.</p>
    </div>
<% end %>

<% if @data && @data[:last_updated] %>
    <div class="last-updated">
        Last updated: <%= format_timestamp(@data[:last_updated]) %>
    </div>
<% end %>